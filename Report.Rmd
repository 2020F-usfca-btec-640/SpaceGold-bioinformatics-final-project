---
title: 'The Brazillian Amazon & COVID-19'
author: "Adam Zimmerman"
date: "December 1, 2020"
output: pdf_document
csl: bioinformatics.csl
bibliography: references.bib
params:
  gff_file_path: "/data/sars_vcf_analysis/02_genome_reference/sars_refgenome_annotation.gff"
  vcf_dir_path: "data/11_vcf_output_for_R"
  sra_runtable_path: "data/00_sra_runtable/SraRunTable_PRJNA662684.txt"
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE,
                      error = TRUE)
```

# Background and Overview

This is a report on SARS-CoV-2 genetic data, as well as some COVID-19 prevalence data for Manaus and Sao Paulo. [@Buss2020.09.16.20194787].

# Methods

## Suggested Sources

* [vcfR package website](https://knausb.github.io/vcfR_documentation/index.html).
* https://kjhealy.github.io/covdata/
* https://github.com/como-ph/oxcovid19
* https://ropensci.org/blog/2020/10/20/searching-medrxivr-and-biorxiv-preprint-data/
* https://covidtracking.com/data/api
  * `readr::read_csv("https://api.covidtracking.com/v1/states/daily.csv")`
* https://rt.live/
  * `readr::read_csv("https://d14wlfuexuxgcm.cloudfront.net/covid/rt.csv")`

# Results and Discussion

```{r load-packages-and-functions}
library("vcfR")
library("ggplot2")
library("dplyr")
library("ggthemes")
library("medrxivr")
library("oxcovid19")
library("lubridate")

# this loads all function files in the code/functions directory
function_paths <- list.files("code/functions", full.names = TRUE)
purrr::walk(function_paths, source)
```

```{r load-vcf-data}
# load in, tidy, and stack all of the VCF files in the target directory
# these are the output of the bash pipeline
stacked_vcfs <- parse_tidy_and_stack_vcfs(
  vcf_dir_path = params$vcf_dir_path)

# load in the gff file with genome annotations for SARS-CoV-2
gff <- read_gff(gff_file_path = params$gff_file_path)

# pull out just the named genes from the annotation file
gene_table <- extract_genes_from_gff(annotation_object = gff)

# combine the stacked vcf table with the gene names and the metadata from
# the sra runtable file
vcf_with_metadata <- add_genes_metadata_to_vcfstack(
  sra_runtable_path = params$sra_runtable_path,
  stacked_vcf = stacked_vcfs,
  cleaned_genes_table = gene_table)
```

```{r load-confirmed-data}
# OxCOVID19 confirmed cases setup
# this loads all function files in the code/functions directory
function_paths <- list.files("code/functions", full.names = TRUE)
purrr::walk(function_paths, source)

## Step 1: Create a connection to OxCOVID19 PostgreSQL server
con <- connect_oxcovid19()

## Step 2: Access epidemiology table from OxCOVID19 PostgreSQL server
epi_tab <- get_table(con = con, tbl_name = "epidemiology")

## Step 3: Query the epidemiology table to show data for Brazil
bra_epi_tab <- dplyr::filter(.data = epi_tab, countrycode == "BRA", adm_area_1 
                             %in% c("Amazonas", "São Paulo"))
# readr::write_csv(bra_epi_tab, "./output/confirmed.csv")
```

# Figures

```{r confirmed-plot}
# produce a colored line plot of confirmed cases by state
confirmed_plot <- bra_epi_tab %>%
  group_by(date) %>%
  ggplot(aes(x = date,
             y = confirmed)) +
  geom_line(aes(colour=adm_area_1)) +
  labs(title = "Confirmed COVID-19 cases over time",
       x = "Date",
       y = "Confirmed Cases") +
  theme_clean()

ggsave(plot = confirmed_plot,
       filename = "output/figures/confirmed.png")

confirmed_plot
```

**Figure **: The state of São Paulo saw more total confirmed cases than the state of Amazonas.

```{r population-plot}
# produce a pie chart highlighting Sao Paulo and Amazonas vs Total
population_path <- readr::read_csv("data/raw_data/Brazil_populations.csv")
population_data <- population_path %>%
  group_by(population) %>%
  dplyr::filter(RegionName %in% c("Amazonas", "São Paulo", "Total"))

# Remove Amazonas and Sao Paulo populations from Total
population_data[3,3] <- (population_data[3,3] - population_data[2,3] - population_data[1,3])

# Basic piechart
population_plot <- ggplot(population_data, aes(x="", y=population, fill=RegionName)) +
  geom_bar(stat="identity", width=1, color="white") +
  coord_polar("y", start=0) +
  labs(title = "Populations of Brazil") +
  theme_void() # remove background, grid, numeric labels

# TODO: Adam fix ggsave; broken 2020-11-29
# ggsave("output/figures/population_plot.png", population_plot, device = "png")

population_plot

ggsave(plot = population_plot,
       filename = "output/figures/population_plot.png")
```

**Figure**: Sao Paulo is much larger than Amazonas by population.

```{r per-capita-plot}
# produce a dual line plot of confirmed cases by state, Amazonas or Sao Paul
per_capita_amazonas <- bra_epi_tab %>%
  dplyr::filter(adm_area_1 == "Amazonas") %>%
  group_by(date) %>%
  dplyr::mutate(per_capita_a = confirmed/4207714) %>%
  dplyr::select(date, per_capita_a)

per_capita_sp <- bra_epi_tab %>%
  dplyr::filter(adm_area_1 == "São Paulo") %>%
  group_by(date) %>%
  dplyr::mutate(per_capita_s = confirmed/46289333) %>%
  dplyr::select(date, per_capita_s)

# per_capita_amazonas
# per_capita_sp
per_capita_plot <- ggplot() +
  geom_line(data=per_capita_amazonas, aes(x = date, y = per_capita_a, color = "Amazonas")) +
  geom_line(data=per_capita_sp, aes(x = date, y = per_capita_s, color = "São Paulo")) +
  labs(title = "Confirmed COVID-19 cases per capita over time",
       x = "Date",
       y = "Confirmed Cases Per Capita") +
  theme_clean()
per_capita_plot
```

**Figure**: Amazonas saw greater confirmed cases per capita than São Paulo.

```{r prevalence-plot}
# produce a dual-line plot of seroreversion adjusted prevalence of SARS-CoV-2
# antibodies across Manaus and Sao Paulo
prevalence_path <- readr::read_csv("data/raw_data/Seroreversion_adjusted_prevalence.csv")
prevalence_plot <- prevalence_path %>%
  
  labs(title = "Seroreversion adjusted prevalence of SARS-CoV-2 antibodies
                     across Manaus and São Paulo",
       x = "Month",
       y = "Antibody prevalence") +
  theme_clean()

ggsave(plot = prevalence_plot,
       filename = "output/figures/prevalence_plot.png")

prevalence_plot
```

**Figure**: Manaus saw more widespread prevalence of SARS-CoV-2 antibodies vs. São Paulo, up to 66% vs. 22% of the population respectively.

```{r sample-plot}
# create a plot of unique SNP locations within each gene across all samples
vcf_with_metadata %>%
  filter(!is.na(gene)) %>% # get rid of SNPs not in gene regions
  group_by(gene, pos) %>%
  tally() %>% # this gives a column n for the number of gene by position
  group_by(gene) %>%
  tally() %>% # this collapses that down to the number of unique SNP locations
  ggplot(aes(x = gene,
             y = n)) +
    geom_col() +
    labs(title = "Count of distinct SNPs in Named SARS-CoV-2 Genes",
         x = "Gene Name") +
  theme_few() # get rid of the grey background
```

**Figure**: N and S genes have more unique SNPs in the set of samples analyzed.

# Tables

```{r example-table}
# An example table to show the length of each gene using its start and end
gene_table %>%
  mutate(length = end - start) %>%
  select(gene_name, start, end, length) %>%
  knitr::kable(col.names = c("Gene Name",
                             "Start",
                             "End",
                             "Length"))
```

**Table 1**: Gene names, locations, and lengths in the SARS-CoV-2 genome. Higher SNP counts in the S and N genes may be related to the larger size of these genes.

# Sources Cited
